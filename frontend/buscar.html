<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Buscar Películas - Yosflix</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Inter', sans-serif;
    background-color: #000;
    color: #fff;
    overflow-x: hidden;
  }
  .tecla {
    background-color: #374151;
    transition: background-color 0.2s;
    cursor: pointer;
  }
  .tecla:hover, .tecla:focus {
    background-color: #4b5563;
    outline: none;
  }
  .focus-visible {
    outline: 3px solid #ef4444;
    outline-offset: 2px;
  }
</style>
</head>
<body class="flex flex-col min-h-screen">

<header
  class="fixed top-0 left-0 w-full z-50 bg-gradient-to-b from-black to-transparent py-4 px-8 flex items-center justify-between"
>
  <div class="text-red-600 text-3xl font-bold rounded-md cursor-pointer select-none" onclick="location.href='yosflix.html'">Y</div>
  <div class="flex items-center space-x-6">
    <div
      id="perfil-image"
      class="w-8 h-8 bg-blue-500 rounded-md cursor-pointer overflow-hidden"
      tabindex="0"
      title="Perfil"
      aria-label="Perfil"
    >
      <img
        src="/perfil-imagen.jpg"
        alt="imagen de perfil"
        class="w-full h-full object-cover"
      />
    </div>
  </div>
</header>

<main class="flex-grow pt-20 px-8 max-w-7xl mx-auto w-full flex gap-12">

  <!-- Área de búsqueda + teclado (izquierda) -->
  <div class="flex flex-col w-[480px]">
    <div class="relative flex w-full mb-6">
      <input
        id="search-input"
        type="text"
        placeholder="Buscar título, tag o año..."
        class="flex-grow bg-gray-800 text-white rounded-l-md px-4 py-3 focus:outline-none focus:ring-2 focus:ring-red-600 text-lg"
        autocomplete="off"
        spellcheck="false"
        autofocus
      />

      <!-- Teclado Virtual -->
      <div
        id="virtual-keyboard"
        class="absolute top-full mt-4 bg-gray-900 p-6 rounded-lg shadow-lg z-10 w-full select-none"
        aria-label="Teclado virtual"
        style="left:0;"
      >
        <div class="grid grid-cols-7 gap-3 text-center text-lg">
          <!-- Letras y números -->
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="a">a</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="b">b</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="c">c</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="d">d</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="e">e</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="f">f</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="g">g</button>

          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="h">h</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="i">i</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="j">j</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="k">k</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="l">l</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="m">m</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="n">n</button>

          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="ñ">ñ</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="o">o</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="p">p</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="q">q</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="r">r</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="s">s</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="t">t</button>

          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="u">u</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="v">v</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="w">w</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="x">x</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="y">y</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="z">z</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="1">1</button>

          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="2">2</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="3">3</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="4">4</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="5">5</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="6">6</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="7">7</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="8">8</button>

          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="9">9</button>
          <button class="tecla rounded-md py-3 px-5 text-white font-semibold" data-key="0">0</button>
          <button class="tecla col-span-2 rounded-md py-3 px-5 text-white font-semibold" data-key="backspace">⌫</button>
          <button class="tecla col-span-2 rounded-md py-3 px-5 text-white font-semibold" data-key="space">Espacio</button>

          <!-- Botón buscar -->
          <button
            id="btn-search"
            class="col-span-1 bg-red-600 hover:bg-red-700 rounded-md py-3 px-5 text-white font-semibold transition flex justify-center items-center"
            aria-label="Buscar"
          >
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Área resultados (tarjetas) a la derecha -->
  <div class="flex-1">
    <div
      id="search-results"
      class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 justify-end"
      style="max-width: 85vw;"
    >
      <!-- Películas inyectadas aquí -->
    </div>
    <p id="no-results" class="mt-4 text-gray-400 text-center hidden select-none">
      No se encontraron películas.
    </p>
  </div>

</main>

<script src="/frontend/peliculas.js"></script>
<script>
  const searchInput = document.getElementById('search-input');
  const resultsContainer = document.getElementById('search-results');
  const noResultsText = document.getElementById('no-results');
  const btnSearch = document.getElementById('btn-search');

  function fuzzyMatch(str, pattern) {
    str = str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    pattern = pattern.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    if (str.includes(pattern)) return true;

    const maxErrors = 1;
    let errors = 0, i = 0, j = 0;
    while (i < str.length && j < pattern.length) {
      if (str[i] === pattern[j]) { i++; j++; }
      else {
        errors++;
        if (errors > maxErrors) return false;
        if (str.length > pattern.length) i++;
        else if (str.length < pattern.length) j++;
        else { i++; j++; }
      }
    }
    errors += (str.length - i) + (pattern.length - j);
    return errors <= maxErrors;
  }

  function renderPeliculas(lista) {
    resultsContainer.innerHTML = '';
    if (lista.length === 0) {
      noResultsText.classList.remove('hidden');
      return;
    }
    noResultsText.classList.add('hidden');

    lista.forEach(peli => {
      const card = document.createElement('div');
      card.className = "relative rounded-lg overflow-hidden cursor-pointer hover:scale-105 transition-transform duration-300 shadow-lg w-52 h-80";
      card.tabIndex = 0;
      card.setAttribute('role', 'link');
      card.setAttribute('aria-label', `Ver detalles de ${peli.titulo}`);

      card.innerHTML = `
        <img src="${peli.miniatura}" alt="${peli.titulo}" class="w-full h-full object-cover" />
      `;

      card.addEventListener('click', () => {
        window.location.href = `detalles.html?titulo=${encodeURIComponent(peli.titulo)}`;
      });
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          card.click();
        }
      });

      resultsContainer.appendChild(card);
    });
  }

  function filtrarPeliculas(texto) {
    if (!texto.trim()) {
      renderPeliculas(window.peliculas || []);
      return;
    }
    const filtro = texto.trim().toLowerCase();

    const filtradas = (window.peliculas || []).filter(peli => {
      if (fuzzyMatch(peli.titulo, filtro)) return true;
      if (peli.tags.some(tag => fuzzyMatch(tag, filtro))) return true;
      if (peli.año.toString().includes(filtro)) return true;
      return false;
    });

    renderPeliculas(filtradas);
  }

  // Inicial
  document.addEventListener('DOMContentLoaded', () => {
    renderPeliculas(window.peliculas || []);
  });

  // Buscar en input en vivo
  searchInput.addEventListener('input', e => {
    filtrarPeliculas(e.target.value);
  });

  // Botón buscar
  btnSearch.addEventListener('click', () => {
    filtrarPeliculas(searchInput.value);
  });

  // Teclado virtual funcionalidad
  const keyboard = document.getElementById('virtual-keyboard');
  keyboard.addEventListener('click', e => {
    if (!e.target.classList.contains('tecla')) return;
    const key = e.target.dataset.key;
    if (!key) return;

    const start = searchInput.selectionStart;
    const end = searchInput.selectionEnd;
    let val = searchInput.value;

    if (key === 'backspace') {
      if (start === end && start > 0) {
        searchInput.value = val.slice(0, start - 1) + val.slice(end);
        searchInput.selectionStart = searchInput.selectionEnd = start - 1;
      } else {
        searchInput.value = val.slice(0, start) + val.slice(end);
        searchInput.selectionStart = searchInput.selectionEnd = start;
      }
    } else if (key === 'space') {
      searchInput.value = val.slice(0, start) + ' ' + val.slice(end);
      searchInput.selectionStart = searchInput.selectionEnd = start + 1;
    } else {
      searchInput.value = val.slice(0, start) + key + val.slice(end);
      searchInput.selectionStart = searchInput.selectionEnd = start + key.length;
    }
    searchInput.focus();
    filtrarPeliculas(searchInput.value);
  });
</script>

</body>
</html>
